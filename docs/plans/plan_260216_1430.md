# Plan: Image Embeddings Model Distribution Improvements

**Date:** 2026-02-16 14:30
**Status:** Defined

## Objective

Simplify the developer experience for acquiring the necessary CLIP ONNX models (`text_model.onnx`, `vision_model.onnx`, `vocab.json`, `merges.txt`) for the `ElBruno.LocalEmbeddings.ImageEmbeddings` library.

## Strategy

We will implement a phased approach:

1. **Scripts (Immediate):** Provide cross-platform scripts to manually download models.
2. **Downloader Library (Robust):** Create a dedicated component for managing model downloads programmatically.
3. **Integration (Convenience):** Integrate the downloader into the main library with an `EnsureModelDownloaded` option that safeguards startup.

## Phase 1: Scripts and Documentation (Option B + H)

Create helper scripts to download the CLIP ViT-B/32 models from a reliable public mirror (e.g., Hugging Face Hub `Xenova/clip-vit-base-patch32` which provides ONNX-ready files).

### Tasks

1. **Create `scripts/` folder** in repo root.
2. **Create `scripts/download_clip_models.ps1`**:
    * PowerShell script to download the 4 required files.
    * Parameters: `-OutputDirectory` (default: `./clip-models`).
    * Progress indication.
3. **Create `scripts/download_clip_models.sh`**:
    * Bash equivalent for Linux/macOS.
4. **Update Documentation**:
    * Update `src/ElBruno.LocalEmbeddings.ImageEmbeddings/README.md`.
    * Update `samples/README.md` and individual sample READMEs.
    * Mention these scripts as the recommended setup step.

## Phase 2: Model Downloader Library (Option E)

Encapsulate the download logic in a reusable .NET library. This separates the "heavy lifting" of HTTP/IO from the core inference runtime, though we may link them later.

### Tasks

1. **Create Project**: `src/ElBruno.LocalEmbeddings.ImageEmbeddings.Downloader/` (or similar name).
2. **Dependencies**:
    * `Microsoft.Extensions.Http`
    * `Microsoft.Extensions.Logging.Abstractions`
3. **Implementation**:
    * `IImageModelDownloader` interface.
    * `HuggingFaceImageModelDownloader` implementation.
    * Logic to check existence, hash/size (basic validation), and download missing files.
    * Default source: `Xenova/clip-vit-base-patch32` (or similar stable ONNX source).

## Phase 3: Integration & Safety (EnsureModelDownloaded)

Connect the downloader to the main library to allow auto-provisioning and startup safety.

### Tasks

1. **Update `ImageEmbeddingsOptions`**:
    * Add `bool EnsureModelDownloaded { get; set; } = false;` (Default false to start, or true if we want parity with text lib).
    * Add `string ModelDownloadUrl { get; set; }` (optional custom source).
2. **Update `ServiceCollectionExtensions`**:
    * In `AddImageEmbeddings`, if `EnsureModelDownloaded` is true:
        * Check for model files.
        * If missing, invoke the Downloader (requires determining how main lib references Downloader - likely a ProjectReference).
        * **CRITICAL**: If files are missing and download fails (or is disabled), throw a clear `InvalidOperationException` to prevent the process from starting in a broken state.
3. **Refactor Encoders**:
    * Ensure constructors throw friendly errors if files are missing (currently `InferenceSession` might throw native errors; wrap this).

## Proposed Folder Structure Changes

```
src/
  ElBruno.LocalEmbeddings.ImageEmbeddings/      # Core (References Downloader?)
  ElBruno.LocalEmbeddings.ImageEmbeddings.Downloader/ # New Lib
scripts/
  download_clip_models.ps1
  download_clip_models.sh
```

## Dependencies & Risks

- **Network Access**: Auto-download requires internet; verify behavior in offline/air-gapped scenarios (fail fast).
* **Model Hosting**: Relying on external Hugging Face repos (Xenova etc.) creates a dependency. Consider hosting a mirror if needed later.
