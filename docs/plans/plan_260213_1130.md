# Plan: ConsoleApp Linux ONNX Runtime Compatibility (Windows-safe)

**Created:** 2026-02-13 11:30  
**Status:** Draft — ready for implementation

---

## Goal

Fix the `samples/ConsoleApp` runtime crash on Linux ARM64 (`DllNotFoundException` for ONNX Runtime native library) while preserving current behavior on Windows.

---

## Current Issue Snapshot

- `dotnet build` succeeds for the full solution.
- `dotnet run` in `samples/ConsoleApp` fails on Linux ARM64 during ONNX Runtime initialization.
- Failure occurs in `OnnxEmbeddingModel.Load(...)` when creating `SessionOptions` / loading native runtime.

---

## Implementation Strategy

### Phase 1 — Repro and diagnostics hardening

1. Keep a deterministic repro from `samples/ConsoleApp` on Linux ARM64.
2. Add targeted diagnostics in native-load failure paths to print:
   - OS and architecture
   - model path
   - expected native library names/locations
3. Ensure diagnostics do not alter success path behavior.

### Phase 2 — Minimal cross-platform fix (preferred)

1. Implement a Linux-only native runtime compatibility shim in core library startup:
   - Scope: `src/ElBruno.LocalEmbeddings/OnnxEmbeddingModel.cs` (or a small internal helper)
   - Behavior: attempt explicit pre-load of Linux native ONNX runtime artifact before `SessionOptions` initialization, only when needed.
2. Guard by runtime checks:
   - apply only on Linux
   - no-op on Windows and macOS
3. Keep public API unchanged.

### Phase 3 — Validate package/runtime compatibility

1. Verify whether current ONNX Runtime package version has known Linux ARM64 probing/naming behavior.
2. If needed, adjust package/reference strategy with minimal blast radius.
3. Re-run build and tests to confirm no regressions.

### Phase 4 — Sample strategy decision point

If Phase 2 requires large, platform-specific complexity in core code, pivot to a split sample strategy:

- Keep `samples/ConsoleApp` as the canonical cross-platform sample.
- Add Linux-focused sample (example: `samples/ConsoleApp.Linux`) with explicit Linux runtime guidance.

**Decision rule:**

- If fix is small/internal and no API changes → keep single sample.
- If fix introduces high maintenance/platform branching in core path → add Linux-specific sample.

---

## Files likely impacted

- `src/ElBruno.LocalEmbeddings/OnnxEmbeddingModel.cs` — native load compatibility behavior
- `src/ElBruno.LocalEmbeddings/LocalEmbeddingGenerator.cs` — optional improved error propagation/context
- `samples/ConsoleApp/Program.cs` — optional friendlier startup error handling
- `README.md` and/or `docs/getting-started.md` — platform notes (if needed)
- `samples/README.md` — document Linux-specific sample only if Phase 4 is triggered

---

## Verification checklist

1. `dotnet build` from repo root passes.
2. `dotnet test` from repo root passes.
3. `dotnet run --project samples/ConsoleApp` succeeds on Linux ARM64.
4. Windows run remains unchanged/successful (validated by CI or maintainer environment).
5. No public API breaking changes.

---

## Risk and rollback

- **Risk:** native-load handling can vary by runtime packaging and architecture.
- **Mitigation:** isolate Linux-specific handling behind runtime checks and preserve existing path for Windows.
- **Rollback:** remove shim and keep platform guidance/sample split if regressions appear.

---

## Roadmap alignment

This plan maps to a new roadmap item:

- **Cross-platform native runtime reliability for samples (Linux ARM64 + Windows parity)**

Roadmap file updated: `docs/plans/roadmap_260213_0803.md`.
