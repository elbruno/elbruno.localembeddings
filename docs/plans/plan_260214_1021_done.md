# Plan — Implement issue #24: Resource Leaks, DX, Tests, and Polish ✅ DONE

**Created:** 2026-02-14 10:21  
**Status:** ✅ Completed (2026-02-14)  
**Issue:** <https://github.com/elbruno/elbruno.localembeddings/issues/24>  
**Scope:** Deliver an incremental, low-risk implementation of the improvement items proposed in issue #24.

## Objectives

- Fix high-priority correctness/resource issues first.
- Improve developer experience without introducing breaking changes.
- Increase test coverage where current risk is highest.
- Add lightweight polish/documentation updates that clarify behavior and performance expectations.

## Proposed Delivery Strategy

### Phase 1 — High Priority (must-do first)

1. **Fix `HttpClient` lifetime in `LocalEmbeddingGenerator`**
   - Replace ad-hoc `new HttpClient()` usages with a safe lifetime strategy.
   - Preferred approach: inject/download via reusable client (or factory-backed pattern).
   - Ensure no undisposed client remains in constructor/factory paths.

2. **Address sync-over-async constructor behavior**
   - Keep current API compatibility while reducing deadlock risk.
   - Promote async-first creation path (`CreateAsync`) in XML docs and getting-started docs.
   - Add clear warning notes where sync constructor is retained.

**Exit criteria (Phase 1):**

- No direct leaking `HttpClient` allocations in initialization paths.
- Constructor behavior documented with explicit guidance.
- Existing tests pass.

### Phase 2 — Medium Priority (DX + ergonomics)

1. **KernelMemory search-only registration convenience**
   - Add a dedicated extension for search-only scenarios.
   - Auto-register a no-op text generator when LLM generation is not required.

2. **Add `IAsyncDisposable` support**
   - Implement `IAsyncDisposable` on `LocalEmbeddingGenerator` (and related owned resources as needed).
   - Preserve current `IDisposable` behavior.

3. **Improve cancellation propagation**
   - Ensure `CancellationToken` is passed through long-running tokenization/inference paths.
   - Add cancellation tests for batch and larger input scenarios.

4. **Add `CHANGELOG.md`**
   - Start with unreleased section and include issue #24 improvements.

**Exit criteria (Phase 2):**

- Search-only KernelMemory path works without requiring an LLM text generator.
- `await using` supported where applicable.
- Cancellation can interrupt meaningful work beyond pre-checks.
- Changelog introduced and referenced.

### Phase 3 — Lower Priority (tests + robustness)

1. **KernelMemory adapter tests**
   - Add table-driven tests for:
     - `CountTokens()`
     - `GetTokens()`
     - `GenerateEmbeddingAsync()`
     - disposal behavior (`ownsGenerator` true/false)

2. **DI registration tests (core)**
   - Validate all `AddLocalEmbeddings()` overloads register expected services.
   - Include argument validation and service resolution tests.

3. **Token counting accuracy improvement**
   - Replace/augment whitespace heuristic in adapter with tokenizer-backed counting.
   - Keep fallback behavior explicit if tokenizer unavailable.

4. **Direct tests for `OnnxEmbeddingModel`**
    - Add focused unit tests for pooling/normalization/session lifecycle with deterministic fixtures.

**Exit criteria (Phase 3):**

- Coverage improved in the highest-risk adapter/DI/inference paths.
- Token counting behavior documented and tested.

### Phase 4 — Nice-to-Have polish

1. **Evaluate central package management (`Directory.Packages.props`)**
    - Introduce only if repo-wide impact is acceptable in this cycle.

2. **VectorData convenience helpers**
    - Add high-value helper(s) that reduce common boilerplate.

3. **Add optional logging/diagnostics hooks**
    - Structured logs around model download/load/inference timing.

4. **Document `FindClosest` complexity expectations**
    - Update XML docs to clarify linear scan behavior and guidance for larger datasets.

## Implementation Notes

- Keep changes incremental and reviewable (small PRs/commits by phase).
- Avoid broad refactors while fixing issue #24.
- Maintain nullable safety and existing naming conventions.
- Prefer extension methods and DI patterns already used in repo.

## Validation Plan

For each phase:

- Run build and tests locally.
- Add/adjust tests alongside code changes.
- Update docs when behavior or API guidance changes.

Final validation:

- `dotnet build`
- `dotnet test`

## Risks and Mitigations

- **Risk:** constructor behavior changes could surprise existing consumers.  
  **Mitigation:** keep compatibility; document async-first guidance prominently.

- **Risk:** disposal/cancellation changes can be subtle.  
  **Mitigation:** add targeted tests for lifecycle and cancellation paths.

- **Risk:** introducing too many improvements at once increases regression potential.  
  **Mitigation:** implement in phased slices with checkpoints and test gates.

## Definition of Done

- High-priority items (1–2) are complete and validated.
- Medium-priority items (3–6) are complete or explicitly deferred with rationale.
- Test additions (7–10) cover critical paths and pass in CI.
- Documentation/changelog updated to reflect delivered behavior.
