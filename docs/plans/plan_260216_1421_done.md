# Plan — ElBruno.LocalEmbeddings.ImageEmbeddings Library ✅ DONE

**Created:** 2026-02-16 14:21  
**Status:** ✅ Completed (2026-02-16)  
**Scope:** Create a new `ElBruno.LocalEmbeddings.ImageEmbeddings` library for CLIP-based image embeddings, plus two sample applications demonstrating image RAG workflows.

## Goals

- Extract and productionize the CLIP image/text encoding from `samples/ImageSearchSample/` into a reusable library `ElBruno.LocalEmbeddings.ImageEmbeddings`.
- Provide a simple, easy-to-use API where C# developers can pass an image and get embeddings.
- Support image search and image-based RAG scenarios.
- Create two sample applications:
  1. **ImageRagSimple** — Minimal console app showing basic image RAG steps.
  2. **ImageRagChat** — Full interactive chat doing RAG on images.

## Background

The `samples/ImageSearchSample/` demonstrates multimodal text-to-image semantic search using CLIP models. This plan promotes the core CLIP encoding components into a proper library following the repository's established companion package pattern (`ElBruno.LocalEmbeddings.KernelMemory`, `ElBruno.LocalEmbeddings.VectorData`).

## Architecture

```
src/ElBruno.LocalEmbeddings.ImageEmbeddings/
├── ElBruno.LocalEmbeddings.ImageEmbeddings.csproj
├── ClipImageEncoder.cs          # CLIP vision ONNX model, image preprocessing
├── ClipTextEncoder.cs           # CLIP text ONNX model, text encoding
├── ClipTokenizer.cs             # BPE tokenizer for CLIP
├── ImageSearchEngine.cs         # Index images + search by text/image
├── Options/
│   └── ImageEmbeddingsOptions.cs  # Configuration (model paths, etc.)
└── Extensions/
    └── ServiceCollectionExtensions.cs  # DI registration

tests/ElBruno.LocalEmbeddings.ImageEmbeddings.Tests/
├── ElBruno.LocalEmbeddings.ImageEmbeddings.Tests.csproj
├── ClipTokenizerTests.cs
├── ImageSearchEngineTests.cs
└── ServiceCollectionExtensionsTests.cs

samples/ImageRagSimple/          # Minimal image RAG demo
├── ImageRagSimple.csproj
└── Program.cs

samples/ImageRagChat/            # Full interactive image RAG chat
├── ImageRagChat.csproj
├── Program.cs
└── ConsoleUi/
    └── ImageRagChatConsoleRenderer.cs
```

## Implementation Checklist

### Phase 1: Library

- [x] **Create library project** (`src/ElBruno.LocalEmbeddings.ImageEmbeddings/`)
  - Target `net8.0;net10.0`
  - Package references: `Microsoft.ML.OnnxRuntime`, `SixLabors.ImageSharp`, `System.Numerics.Tensors`
  - DI references: `Microsoft.Extensions.DependencyInjection.Abstractions`, `Microsoft.Extensions.Options`
  - Project reference to `ElBruno.LocalEmbeddings`
  - NuGet metadata (PackageId, Description, Authors, etc.)

- [x] **Implement `Options/ImageEmbeddingsOptions.cs`**
  - Model directory path
  - Custom file names for text/vision models, vocab, merges

- [x] **Implement `ClipTokenizer.cs`**
  - BPE tokenizer with vocab.json + merges.txt
  - SOT/EOT special tokens, context length 77

- [x] **Implement `ClipTextEncoder.cs`**
  - Load text ONNX model
  - Tokenize + encode → L2-normalized embedding

- [x] **Implement `ClipImageEncoder.cs`**
  - Load vision ONNX model
  - Image preprocessing (resize 224×224, NCHW, CLIP normalization)
  - Encode → L2-normalized embedding

- [x] **Implement `ImageSearchEngine.cs`**
  - Index images from directory
  - Text-to-image search (cosine similarity)
  - Image-to-image search

- [x] **Implement `Extensions/ServiceCollectionExtensions.cs`**
  - `AddImageEmbeddings(Action<ImageEmbeddingsOptions>)` DI registration

### Phase 2: Tests

- [x] **Create test project** (`tests/ElBruno.LocalEmbeddings.ImageEmbeddings.Tests/`)
  - xUnit + Moq test infrastructure
  - Tests for tokenizer, search engine, DI extensions

### Phase 3: Samples

- [x] **Create `samples/ImageRagSimple/`**
  - Minimal console app: load models → index images → search by text query → display results

- [x] **Create `samples/ImageRagChat/`**
  - Interactive chat: load models → index images → chat loop with natural language queries
  - Rich console UI (Spectre.Console) following RagChat patterns

### Phase 4: Integration

- [x] Add all projects to `ElBruno.LocalEmbeddings.slnx`
- [x] Update `.gitignore` for CLIP model directories
- [x] Update `README.md` with new library and samples
- [x] Update roadmap with new feature entry

### Phase 5: Validation

- [x] `dotnet build` from repo root
- [x] `dotnet test` from repo root
- [x] Verify all new code compiles and tests pass

## Key Design Decisions

1. **Follows companion package pattern** — Like `ElBruno.LocalEmbeddings.KernelMemory` and `ElBruno.LocalEmbeddings.VectorData`, this is a separate NuGet package with its own project.
2. **Reuses core library** — References `ElBruno.LocalEmbeddings` for shared utilities (cosine similarity, embedding extensions).
3. **ImageSharp for cross-platform** — Uses `SixLabors.ImageSharp` for image processing (no system dependencies).
4. **Manual model download** — CLIP models require separate text/vision ONNX files exported from HuggingFace.
5. **Multi-TFM** — Targets both `net8.0` and `net10.0` consistent with existing projects.

## Dependencies

- `Microsoft.ML.OnnxRuntime` — ONNX inference
- `SixLabors.ImageSharp` ≥ 3.1.12 — Image loading and preprocessing
- `System.Numerics.Tensors` — TensorPrimitives for SIMD operations
- `Microsoft.Extensions.DependencyInjection.Abstractions` — DI support
- `Microsoft.Extensions.Options` — Options pattern
