# Plan — Implement Roadmap Items #6 and #7 ✅ DONE

Date: 2026-02-14 03:51  
**Status:** ✅ Completed (2026-02-14)

## Goal

Implement roadmap items [6. True Async Model Loading](./roadmap_260213_0803.md#6-true-async-model-loading) and [7. Quantized Model Support (INT8 / ONNX QDQ)](./roadmap_260213_0803.md#7-quantized-model-support-int8--onnx-qdq) with minimal, backward-compatible changes.

## Scope

- Make `LocalEmbeddingGenerator.CreateAsync(...)` perform true async model download (remove `Task.Run` wrapper).
- Keep the existing constructor path available for synchronous initialization.
- Add `LocalEmbeddingsOptions.PreferQuantized`.
- Add quantized download fallback logic (`model_quantized.onnx` → `model_int8.onnx` → `model.onnx`).
- Make model loading prefer quantized files when configured.
- Add focused unit tests for quantized download behavior and async factory failure path.
- Update roadmap and configuration/API docs for the completed features.

## Non-Goals

- GPU execution providers.
- Model integrity verification.
- Refactoring DI initialization to fully async startup semantics.

## Implementation Steps

1. Add `PreferQuantized` option in `LocalEmbeddingsOptions`.
2. Update `ModelDownloader.EnsureModelAsync(...)` to support quantized preference and fallback behavior.
3. Refactor `LocalEmbeddingGenerator` initialization:
   - shared constructor path with pre-resolved model directory
   - async model resolution in `CreateAsync(...)` without `Task.Run`
   - quantized-aware model file selection when loading ONNX.
4. Update options-copy registration in DI overload to include new and threading-related options.
5. Add/adjust targeted tests in `ModelDownloaderTests` and `LocalEmbeddingGeneratorTests`.
6. Update `docs/configuration.md`, `docs/api-reference.md`, and roadmap completion status for #6/#7.
7. Validate with `dotnet build` and `dotnet test`.

## Acceptance Criteria

- `CreateAsync(...)` no longer uses `Task.Run` for model download.
- Quantized model preference is configurable and gracefully falls back to FP32.
- Existing constructor behavior remains available.
- Targeted tests cover new paths and pass.
- Root `dotnet build` and `dotnet test` pass.
- Roadmap #6 and #7 are marked completed with plan reference.

## Files Expected to Change

- `src/ElBruno.LocalEmbeddings/LocalEmbeddingGenerator.cs`
- `src/ElBruno.LocalEmbeddings/ModelDownloader.cs`
- `src/ElBruno.LocalEmbeddings/Options/LocalEmbeddingsOptions.cs`
- `src/ElBruno.LocalEmbeddings/Extensions/ServiceCollectionExtensions.cs`
- `tests/ElBruno.LocalEmbeddings.Tests/ModelDownloaderTests.cs`
- `tests/ElBruno.LocalEmbeddings.Tests/LocalEmbeddingGeneratorTests.cs`
- `docs/configuration.md`
- `docs/api-reference.md`
- `docs/plans/roadmap_260213_0803.md`
- `docs/plans/plan_260214_0351_done.md` (this file)
